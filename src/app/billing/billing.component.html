<div class="billing-container mat-elevation-z8">
  <mat-card class="billing-card">
    <mat-card-header>
      <mat-card-title>Invoice Generator</mat-card-title>
      <mat-card-subtitle>Create your professional invoice</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <table mat-table [dataSource]="dataSource" class="billing-table">
        <!-- Serial Number Column -->
        <ng-container matColumnDef="sr">
          <th mat-header-cell *matHeaderCellDef>No.</th>
          <td mat-cell *matCellDef="let row; let i = index">{{ i + 1 }}</td>
          <td mat-footer-cell *matFooterCellDef></td>
        </ng-container>

        <!-- Product Column -->
        <ng-container matColumnDef="product">
          <th mat-header-cell *matHeaderCellDef>Product</th>
          <td mat-cell *matCellDef="let row">
            <mat-form-field appearance="outline">
              <mat-select
                [(ngModel)]="row.selectedProduct"
                (selectionChange)="onProductChange($event, row)"
                name="product-{{ row.id }}"
                required
              >
                <mat-option *ngFor="let p of productList" [value]="p">
                  {{ p.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </td>
          <td mat-footer-cell *matFooterCellDef><strong>Total</strong></td>
        </ng-container>

        <!-- HSN Code Column -->
        <ng-container matColumnDef="hsn">
          <th mat-header-cell *matHeaderCellDef>HSN Code</th>
          <td mat-cell *matCellDef="let row">
            {{ row.selectedProduct?.hsnCode || "-" }}
          </td>
          <td mat-footer-cell *matFooterCellDef></td>
        </ng-container>

        <!-- Quantity Column -->
        <ng-container matColumnDef="qty">
          <th mat-header-cell *matHeaderCellDef>QTY</th>
          <td mat-cell *matCellDef="let row">
            <mat-form-field appearance="outline">
              <input
                matInput
                type="number"
                [(ngModel)]="row.quantity"
                (ngModelChange)="calculateAmount(row)"
                [name]="'qty-' + row.id"
                min="1"
                required
              />
              <mat-error>Quantity is required</mat-error>
            </mat-form-field>
          </td>
          <td mat-footer-cell *matFooterCellDef></td>
        </ng-container>

        <!-- Rate Column -->
        <ng-container matColumnDef="rate">
          <th mat-header-cell *matHeaderCellDef>Rate</th>
          <td mat-cell *matCellDef="let row">
            ₹{{ row.selectedProduct?.rate | number : "1.2-2" }}
          </td>
          <td mat-footer-cell *matFooterCellDef><strong>GST (18%)</strong></td>
        </ng-container>

        <!-- Amount Column -->
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>Amount</th>
          <td mat-cell *matCellDef="let row">
            ₹{{ row.amount | number : "1.2-2" }}
          </td>
          <td mat-footer-cell *matFooterCellDef>
            <strong>₹{{ getGST() | number : "1.2-2" }}</strong>
          </td>
        </ng-container>

        <tr
          mat-header-row
          *matHeaderRowDef="displayedColumns; sticky: true"
        ></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        <tr
          mat-footer-row
          *matFooterRowDef="displayedColumns; sticky: true"
        ></tr>
      </table>

      <div class="summary-section mat-elevation-z1">
        <mat-list>
          <div mat-list-item>
            <div class="summary-row">
              <span>Subtotal</span>
              <span class="spacer"></span>
              <strong>₹{{ getTotalAmount() | number : "1.2-2" }}</strong>
            </div>
          </div>
          <mat-divider></mat-divider>
          <div mat-list-item>
            <div class="summary-row">
              <span>GST (18%)</span>
              <span class="spacer"></span>
              <strong>₹{{ getGST() | number : "1.2-2" }}</strong>
            </div>
          </div>
          <mat-divider></mat-divider>
          <div mat-list-item class="total-amount">
            <div class="summary-row">
              <span>Total Amount</span>
              <span class="spacer"></span>
              <strong>₹{{ getFinalAmount() | number : "1.2-2" }}</strong>
            </div>
          </div>
        </mat-list>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-stroked-button color="primary" (click)="addRow()">
        <mat-icon>add</mat-icon> Add Item
      </button>
      <button
        mat-raised-button
        color="primary"
        [disabled]="!isValidForInvoice()"
        (click)="generateInvoice()"
      >
        <mat-icon>receipt</mat-icon> Generate Invoice
      </button>
    </mat-card-actions>
  </mat-card>
</div>
